import { Consensus } from "../types/consensus";
import { QuorumConfig } from "../types/quorumConfig";
// import { Genesis, GenesisConfig, CodeSize, Alloc } from "../types/genesis";
import { Genesis, GenesisConfig, Alloc } from "../types/genesis";
import fs from "fs";
import { CryptoCurve } from "../types/cryptoCurve";
import { NodeKeys } from "../types/nodeKeys";

const GENESIS_FILE = "genesis.json";
const GETH_SUB = "/geth";
const BESU_SUB = "/besu";

function createDefaultGenesis(): Genesis {
  const DefaultMoneyAlloc: Alloc = {
    balance: "90000000000000000000000",
    comment: ""
  };

  const DefaultAlloc: Alloc = {
    balance: "1",
  };

  const DefaultGenesisConfig: GenesisConfig = {
    chainId: 18021982,
    homesteadBlock: 0,
    eip150Block: 0,
    eip150Hash:
      "0x0000000000000000000000000000000000000000000000000000000000000000",
    eip155Block: 0,
    eip158Block: 0,
    byzantiumBlock: 0,
    constantinopleBlock: 0,
    petersburgBlock: 0,
    istanbulBlock: 0,
    berlinBlock: 0,
    londonBlock: 0,
  };

  const genesis: Genesis = {
    nonce: "0x0",
    timestamp: "0x5cfbfcab",
    extraData: "0x0",
    gasLimit: "0x59a5380",
    gasUsed: "0x0",
    // eslint-disable-next-line id-blacklist
    number: "0x0",
    difficulty: "0x1",
    coinbase: "0x1",
    mixHash:
      "0x63746963616c2062797a616e74696e65206661756c7420746f6c6572616e6365",
    parentHash:
      "0x0000000000000000000000000000000000000000000000000000000000000000",
    config: DefaultGenesisConfig,
    alloc: {
      'fe3b557e8fb62b89f4916b721be55ceb828dbd73' : DefaultMoneyAlloc,
      'f17f52151EbEF6C7334FAD080c5704D77216b732' : DefaultMoneyAlloc,
      '627306090abaB3A6e1400e9345bC60c78a8BEf57' : DefaultMoneyAlloc,
      '0000000000000000000000000000000000000000' : DefaultAlloc,
      '0000000000000000000000000000000000000001' : DefaultAlloc,
      '0000000000000000000000000000000000000002' : DefaultAlloc,
      '0000000000000000000000000000000000000003' : DefaultAlloc,
      '0000000000000000000000000000000000000004' : DefaultAlloc,
      '0000000000000000000000000000000000000005' : DefaultAlloc,
      '0000000000000000000000000000000000000006' : DefaultAlloc,
      '0000000000000000000000000000000000000007' : DefaultAlloc,
      '0000000000000000000000000000000000000008' : DefaultAlloc,
      '0000000000000000000000000000000000000009' : DefaultAlloc,
      '000000000000000000000000000000000000000a' : DefaultAlloc,
      '000000000000000000000000000000000000000b' : DefaultAlloc,
      '000000000000000000000000000000000000000c' : DefaultAlloc,
      '000000000000000000000000000000000000000d' : DefaultAlloc,
      '000000000000000000000000000000000000000e' : DefaultAlloc,
      '000000000000000000000000000000000000000f' : DefaultAlloc,
      '0000000000000000000000000000000000000010' : DefaultAlloc,
      '0000000000000000000000000000000000000011' : DefaultAlloc,
      '0000000000000000000000000000000000000012' : DefaultAlloc,
      '0000000000000000000000000000000000000013' : DefaultAlloc,
      '0000000000000000000000000000000000000014' : DefaultAlloc,
      '0000000000000000000000000000000000000015' : DefaultAlloc,
      '0000000000000000000000000000000000000016' : DefaultAlloc,
      '0000000000000000000000000000000000000017' : DefaultAlloc,
      '0000000000000000000000000000000000000018' : DefaultAlloc,
      '0000000000000000000000000000000000000019' : DefaultAlloc,
      '000000000000000000000000000000000000001a' : DefaultAlloc,
      '000000000000000000000000000000000000001b' : DefaultAlloc,
      '000000000000000000000000000000000000001c' : DefaultAlloc,
      '000000000000000000000000000000000000001d' : DefaultAlloc,
      '000000000000000000000000000000000000001e' : DefaultAlloc,
      '000000000000000000000000000000000000001f' : DefaultAlloc,
      '0000000000000000000000000000000000000020' : DefaultAlloc,
      '0000000000000000000000000000000000000021' : DefaultAlloc,
      '0000000000000000000000000000000000000022' : DefaultAlloc,
      '0000000000000000000000000000000000000023' : DefaultAlloc,
      '0000000000000000000000000000000000000024' : DefaultAlloc,
      '0000000000000000000000000000000000000025' : DefaultAlloc,
      '0000000000000000000000000000000000000026' : DefaultAlloc,
      '0000000000000000000000000000000000000027' : DefaultAlloc,
      '0000000000000000000000000000000000000028' : DefaultAlloc,
      '0000000000000000000000000000000000000029' : DefaultAlloc,
      '000000000000000000000000000000000000002a' : DefaultAlloc,
      '000000000000000000000000000000000000002b' : DefaultAlloc,
      '000000000000000000000000000000000000002c' : DefaultAlloc,
      '000000000000000000000000000000000000002d' : DefaultAlloc,
      '000000000000000000000000000000000000002e' : DefaultAlloc,
      '000000000000000000000000000000000000002f' : DefaultAlloc,
      '0000000000000000000000000000000000000030' : DefaultAlloc,
      '0000000000000000000000000000000000000031' : DefaultAlloc,
      '0000000000000000000000000000000000000032' : DefaultAlloc,
      '0000000000000000000000000000000000000033' : DefaultAlloc,
      '0000000000000000000000000000000000000034' : DefaultAlloc,
      '0000000000000000000000000000000000000035' : DefaultAlloc,
      '0000000000000000000000000000000000000036' : DefaultAlloc,
      '0000000000000000000000000000000000000037' : DefaultAlloc,
      '0000000000000000000000000000000000000038' : DefaultAlloc,
      '0000000000000000000000000000000000000039' : DefaultAlloc,
      '000000000000000000000000000000000000003a' : DefaultAlloc,
      '000000000000000000000000000000000000003b' : DefaultAlloc,
      '000000000000000000000000000000000000003c' : DefaultAlloc,
      '000000000000000000000000000000000000003d' : DefaultAlloc,
      '000000000000000000000000000000000000003e' : DefaultAlloc,
      '000000000000000000000000000000000000003f' : DefaultAlloc,
      '0000000000000000000000000000000000000040' : DefaultAlloc,
      '0000000000000000000000000000000000000041' : DefaultAlloc,
      '0000000000000000000000000000000000000042' : DefaultAlloc,
      '0000000000000000000000000000000000000043' : DefaultAlloc,
      '0000000000000000000000000000000000000044' : DefaultAlloc,
      '0000000000000000000000000000000000000045' : DefaultAlloc,
      '0000000000000000000000000000000000000046' : DefaultAlloc,
      '0000000000000000000000000000000000000047' : DefaultAlloc,
      '0000000000000000000000000000000000000048' : DefaultAlloc,
      '0000000000000000000000000000000000000049' : DefaultAlloc,
      '000000000000000000000000000000000000004a' : DefaultAlloc,
      '000000000000000000000000000000000000004b' : DefaultAlloc,
      '000000000000000000000000000000000000004c' : DefaultAlloc,
      '000000000000000000000000000000000000004d' : DefaultAlloc,
      '000000000000000000000000000000000000004e' : DefaultAlloc,
      '000000000000000000000000000000000000004f' : DefaultAlloc,
      '0000000000000000000000000000000000000050' : DefaultAlloc,
      '0000000000000000000000000000000000000051' : DefaultAlloc,
      '0000000000000000000000000000000000000052' : DefaultAlloc,
      '0000000000000000000000000000000000000053' : DefaultAlloc,
      '0000000000000000000000000000000000000054' : DefaultAlloc,
      '0000000000000000000000000000000000000055' : DefaultAlloc,
      '0000000000000000000000000000000000000056' : DefaultAlloc,
      '0000000000000000000000000000000000000057' : DefaultAlloc,
      '0000000000000000000000000000000000000058' : DefaultAlloc,
      '0000000000000000000000000000000000000059' : DefaultAlloc,
      '000000000000000000000000000000000000005a' : DefaultAlloc,
      '000000000000000000000000000000000000005b' : DefaultAlloc,
      '000000000000000000000000000000000000005c' : DefaultAlloc,
      '000000000000000000000000000000000000005d' : DefaultAlloc,
      '000000000000000000000000000000000000005e' : DefaultAlloc,
      '000000000000000000000000000000000000005f' : DefaultAlloc,
      '0000000000000000000000000000000000000060' : DefaultAlloc,
      '0000000000000000000000000000000000000061' : DefaultAlloc,
      '0000000000000000000000000000000000000062' : DefaultAlloc,
      '0000000000000000000000000000000000000063' : DefaultAlloc,
      '0000000000000000000000000000000000000064' : DefaultAlloc,
      '0000000000000000000000000000000000000065' : DefaultAlloc,
      '0000000000000000000000000000000000000066' : DefaultAlloc,
      '0000000000000000000000000000000000000067' : DefaultAlloc,
      '0000000000000000000000000000000000000068' : DefaultAlloc,
      '0000000000000000000000000000000000000069' : DefaultAlloc,
      '000000000000000000000000000000000000006a' : DefaultAlloc,
      '000000000000000000000000000000000000006b' : DefaultAlloc,
      '000000000000000000000000000000000000006c' : DefaultAlloc,
      '000000000000000000000000000000000000006d' : DefaultAlloc,
      '000000000000000000000000000000000000006e' : DefaultAlloc,
      '000000000000000000000000000000000000006f' : DefaultAlloc,
      '0000000000000000000000000000000000000070' : DefaultAlloc,
      '0000000000000000000000000000000000000071' : DefaultAlloc,
      '0000000000000000000000000000000000000072' : DefaultAlloc,
      '0000000000000000000000000000000000000073' : DefaultAlloc,
      '0000000000000000000000000000000000000074' : DefaultAlloc,
      '0000000000000000000000000000000000000075' : DefaultAlloc,
      '0000000000000000000000000000000000000076' : DefaultAlloc,
      '0000000000000000000000000000000000000077' : DefaultAlloc,
      '0000000000000000000000000000000000000078' : DefaultAlloc,
      '0000000000000000000000000000000000000079' : DefaultAlloc,
      '000000000000000000000000000000000000007a' : DefaultAlloc,
      '000000000000000000000000000000000000007b' : DefaultAlloc,
      '000000000000000000000000000000000000007c' : DefaultAlloc,
      '000000000000000000000000000000000000007d' : DefaultAlloc,
      '000000000000000000000000000000000000007e' : DefaultAlloc,
      '000000000000000000000000000000000000007f' : DefaultAlloc,
      '0000000000000000000000000000000000000080' : DefaultAlloc,
      '0000000000000000000000000000000000000081' : DefaultAlloc,
      '0000000000000000000000000000000000000082' : DefaultAlloc,
      '0000000000000000000000000000000000000083' : DefaultAlloc,
      '0000000000000000000000000000000000000084' : DefaultAlloc,
      '0000000000000000000000000000000000000085' : DefaultAlloc,
      '0000000000000000000000000000000000000086' : DefaultAlloc,
      '0000000000000000000000000000000000000087' : DefaultAlloc,
      '0000000000000000000000000000000000000088' : DefaultAlloc,
      '0000000000000000000000000000000000000089' : DefaultAlloc,
      '000000000000000000000000000000000000008a' : DefaultAlloc,
      '000000000000000000000000000000000000008b' : DefaultAlloc,
      '000000000000000000000000000000000000008c' : DefaultAlloc,
      '000000000000000000000000000000000000008d' : DefaultAlloc,
      '000000000000000000000000000000000000008e' : DefaultAlloc,
      '000000000000000000000000000000000000008f' : DefaultAlloc,
      '0000000000000000000000000000000000000090' : DefaultAlloc,
      '0000000000000000000000000000000000000091' : DefaultAlloc,
      '0000000000000000000000000000000000000092' : DefaultAlloc,
      '0000000000000000000000000000000000000093' : DefaultAlloc,
      '0000000000000000000000000000000000000094' : DefaultAlloc,
      '0000000000000000000000000000000000000095' : DefaultAlloc,
      '0000000000000000000000000000000000000096' : DefaultAlloc,
      '0000000000000000000000000000000000000097' : DefaultAlloc,
      '0000000000000000000000000000000000000098' : DefaultAlloc,
      '0000000000000000000000000000000000000099' : DefaultAlloc,
      '000000000000000000000000000000000000009a' : DefaultAlloc,
      '000000000000000000000000000000000000009b' : DefaultAlloc,
      '000000000000000000000000000000000000009c' : DefaultAlloc,
      '000000000000000000000000000000000000009d' : DefaultAlloc,
      '000000000000000000000000000000000000009e' : DefaultAlloc,
      '000000000000000000000000000000000000009f' : DefaultAlloc,
      '00000000000000000000000000000000000000a0' : DefaultAlloc,
      '00000000000000000000000000000000000000a1' : DefaultAlloc,
      '00000000000000000000000000000000000000a2' : DefaultAlloc,
      '00000000000000000000000000000000000000a3' : DefaultAlloc,
      '00000000000000000000000000000000000000a4' : DefaultAlloc,
      '00000000000000000000000000000000000000a5' : DefaultAlloc,
      '00000000000000000000000000000000000000a6' : DefaultAlloc,
      '00000000000000000000000000000000000000a7' : DefaultAlloc,
      '00000000000000000000000000000000000000a8' : DefaultAlloc,
      '00000000000000000000000000000000000000a9' : DefaultAlloc,
      '00000000000000000000000000000000000000aa' : DefaultAlloc,
      '00000000000000000000000000000000000000ab' : DefaultAlloc,
      '00000000000000000000000000000000000000ac' : DefaultAlloc,
      '00000000000000000000000000000000000000ad' : DefaultAlloc,
      '00000000000000000000000000000000000000ae' : DefaultAlloc,
      '00000000000000000000000000000000000000af' : DefaultAlloc,
      '00000000000000000000000000000000000000b0' : DefaultAlloc,
      '00000000000000000000000000000000000000b1' : DefaultAlloc,
      '00000000000000000000000000000000000000b2' : DefaultAlloc,
      '00000000000000000000000000000000000000b3' : DefaultAlloc,
      '00000000000000000000000000000000000000b4' : DefaultAlloc,
      '00000000000000000000000000000000000000b5' : DefaultAlloc,
      '00000000000000000000000000000000000000b6' : DefaultAlloc,
      '00000000000000000000000000000000000000b7' : DefaultAlloc,
      '00000000000000000000000000000000000000b8' : DefaultAlloc,
      '00000000000000000000000000000000000000b9' : DefaultAlloc,
      '00000000000000000000000000000000000000ba' : DefaultAlloc,
      '00000000000000000000000000000000000000bb' : DefaultAlloc,
      '00000000000000000000000000000000000000bc' : DefaultAlloc,
      '00000000000000000000000000000000000000bd' : DefaultAlloc,
      '00000000000000000000000000000000000000be' : DefaultAlloc,
      '00000000000000000000000000000000000000bf' : DefaultAlloc,
      '00000000000000000000000000000000000000c0' : DefaultAlloc,
      '00000000000000000000000000000000000000c1' : DefaultAlloc,
      '00000000000000000000000000000000000000c2' : DefaultAlloc,
      '00000000000000000000000000000000000000c3' : DefaultAlloc,
      '00000000000000000000000000000000000000c4' : DefaultAlloc,
      '00000000000000000000000000000000000000c5' : DefaultAlloc,
      '00000000000000000000000000000000000000c6' : DefaultAlloc,
      '00000000000000000000000000000000000000c7' : DefaultAlloc,
      '00000000000000000000000000000000000000c8' : DefaultAlloc,
      '00000000000000000000000000000000000000c9' : DefaultAlloc,
      '00000000000000000000000000000000000000ca' : DefaultAlloc,
      '00000000000000000000000000000000000000cb' : DefaultAlloc,
      '00000000000000000000000000000000000000cc' : DefaultAlloc,
      '00000000000000000000000000000000000000cd' : DefaultAlloc,
      '00000000000000000000000000000000000000ce' : DefaultAlloc,
      '00000000000000000000000000000000000000cf' : DefaultAlloc,
      '00000000000000000000000000000000000000d0' : DefaultAlloc,
      '00000000000000000000000000000000000000d1' : DefaultAlloc,
      '00000000000000000000000000000000000000d2' : DefaultAlloc,
      '00000000000000000000000000000000000000d3' : DefaultAlloc,
      '00000000000000000000000000000000000000d4' : DefaultAlloc,
      '00000000000000000000000000000000000000d5' : DefaultAlloc,
      '00000000000000000000000000000000000000d6' : DefaultAlloc,
      '00000000000000000000000000000000000000d7' : DefaultAlloc,
      '00000000000000000000000000000000000000d8' : DefaultAlloc,
      '00000000000000000000000000000000000000d9' : DefaultAlloc,
      '00000000000000000000000000000000000000da' : DefaultAlloc,
      '00000000000000000000000000000000000000db' : DefaultAlloc,
      '00000000000000000000000000000000000000dc' : DefaultAlloc,
      '00000000000000000000000000000000000000dd' : DefaultAlloc,
      '00000000000000000000000000000000000000de' : DefaultAlloc,
      '00000000000000000000000000000000000000df' : DefaultAlloc,
      '00000000000000000000000000000000000000e0' : DefaultAlloc,
      '00000000000000000000000000000000000000e1' : DefaultAlloc,
      '00000000000000000000000000000000000000e2' : DefaultAlloc,
      '00000000000000000000000000000000000000e3' : DefaultAlloc,
      '00000000000000000000000000000000000000e4' : DefaultAlloc,
      '00000000000000000000000000000000000000e5' : DefaultAlloc,
      '00000000000000000000000000000000000000e6' : DefaultAlloc,
      '00000000000000000000000000000000000000e7' : DefaultAlloc,
      '00000000000000000000000000000000000000e8' : DefaultAlloc,
      '00000000000000000000000000000000000000e9' : DefaultAlloc,
      '00000000000000000000000000000000000000ea' : DefaultAlloc,
      '00000000000000000000000000000000000000eb' : DefaultAlloc,
      '00000000000000000000000000000000000000ec' : DefaultAlloc,
      '00000000000000000000000000000000000000ed' : DefaultAlloc,
      '00000000000000000000000000000000000000ee' : DefaultAlloc,
      '00000000000000000000000000000000000000ef' : DefaultAlloc,
      '00000000000000000000000000000000000000f0' : DefaultAlloc,
      '00000000000000000000000000000000000000f1' : DefaultAlloc,
      '00000000000000000000000000000000000000f2' : DefaultAlloc,
      '00000000000000000000000000000000000000f3' : DefaultAlloc,
      '00000000000000000000000000000000000000f4' : DefaultAlloc,
      '00000000000000000000000000000000000000f5' : DefaultAlloc,
      '00000000000000000000000000000000000000f6' : DefaultAlloc,
      '00000000000000000000000000000000000000f7' : DefaultAlloc,
      '00000000000000000000000000000000000000f8' : DefaultAlloc,
      '00000000000000000000000000000000000000f9' : DefaultAlloc,
      '00000000000000000000000000000000000000fa' : DefaultAlloc,
      '00000000000000000000000000000000000000fb' : DefaultAlloc,
      '00000000000000000000000000000000000000fc' : DefaultAlloc,
      '00000000000000000000000000000000000000fd' : DefaultAlloc,
      '00000000000000000000000000000000000000fe' : DefaultAlloc      
    },
  };
  return genesis;
}

export function createBesuGenesis(
  path: string,
  quorumConfig: QuorumConfig,
  extraData: string,
  node: NodeKeys[]
): string {
  const genesisFile = path + BESU_SUB + "/" + GENESIS_FILE;
  const besu: Genesis = createDefaultGenesis();
  besu.extraData = extraData;
  besu.gasLimit = quorumConfig.gasLimit;
  besu.coinbase = quorumConfig.coinbase;
  besu.difficulty = "0x" + quorumConfig.difficulty.toString(16);
  besu.config.chainId = quorumConfig.chainID;
  const consensus = quorumConfig.consensus;
  if (quorumConfig.curve === CryptoCurve.r1) {
    besu.config.ecCurve = "secp256r1";
  }
  if (quorumConfig.quickstartDevAccounts === false) {
    besu.alloc = {};
  }
  node.forEach((account) => {
    besu.alloc[account.ethAccount.address] = {
      balance: "1000000000000000000000000000",
    };
  });
  switch (consensus) {
    case Consensus.clique: {
      besu.config.clique = {
        blockperiodseconds: quorumConfig.blockperiod,
        epochlength: quorumConfig.epochLength,
        requesttimeoutseconds: quorumConfig.requestTimeout,
      };
      break;
    }
    case Consensus.ibft2: {
      besu.config.ibft2 = {
        blockperiodseconds: quorumConfig.blockperiod,
        epochlength: quorumConfig.epochLength,
        requesttimeoutseconds: quorumConfig.requestTimeout,
      };
      break;
    }
    case Consensus.qbft: {
      besu.config.qbft = {
        blockperiodseconds: quorumConfig.blockperiod,
        epochlength: quorumConfig.epochLength,
        requesttimeoutseconds: quorumConfig.requestTimeout,
      };
      break;
    }
    default: {
      break;
    }
  }
  fs.writeFileSync(genesisFile, JSON.stringify(besu, null, 2));
  return genesisFile;
}

export function createGethGenesis(
  path: string,
  quorumConfig: QuorumConfig,
  extraData: string,
  node: NodeKeys[]
): string {
  // const DefaultCodeSize: CodeSize = {
  //   block: 0,
  //   size: quorumConfig.maxCodeSize,
  // };

  const genesisFile = path + GETH_SUB + "/" + GENESIS_FILE;
  const geth: Genesis = createDefaultGenesis();
  geth.extraData = extraData;
  geth.gasLimit = quorumConfig.gasLimit;
  geth.coinbase = quorumConfig.coinbase;
  geth.difficulty = "0x" + quorumConfig.difficulty.toString(16);
  geth.config.isQuorum = true;
  geth.config.chainId = quorumConfig.chainID;
  // geth.config.maxCodeSizeConfig = [DefaultCodeSize];
  // geth.config.txnSizeLimit = quorumConfig.txnSizeLimit;
  if (quorumConfig.quickstartDevAccounts === false) {
    geth.alloc = {};
  }
  node.forEach((account) => {
    geth.alloc[account.ethAccount.address] = {
      balance: "1000000000000000000000000000",
    };
  });
  const consensus = quorumConfig.consensus;
  switch (consensus) {
    case Consensus.clique: {
      geth.config.clique = {
        // policy: 0,
        period: quorumConfig.blockperiod,
        epoch: quorumConfig.epochLength,
      };
      break;
    }
    case Consensus.ibft: {
      geth.config.ibft = {
        // policy: 0,
        epoch: quorumConfig.epochLength,
        ceil2Nby3Block: 0,
        blockperiodseconds: quorumConfig.blockperiod,
      };
      break;
    }
    case Consensus.qbft: {
      geth.config.qbft = {
        // policy: 0,
        epoch: quorumConfig.epochLength,
        ceil2Nby3Block: 0,
        testQBFTBlock: 0,
        blockperiodseconds: quorumConfig.blockperiod,
        emptyblockperiodseconds: quorumConfig.emptyBlockPeriod,
      };
      break;
    }
    case Consensus.raft: {
      // raft = no block so ignoring
      break;
    }
    default: {
      break;
    }
  }
  fs.writeFileSync(genesisFile, JSON.stringify(geth, null, 2));
  return genesisFile;
}
